import{r as o,u as w,a as O,b as C,j as s,N as y,c as e,s as R,L as D,d as F,e as T,R as G,O as M,F as x,D as P,f as U,g as z,E as S}from"./index-4b638fea.js";import{u as A}from"./useConfirmModal-a114480e.js";import{l as H,u as j}from"./useSocket-4f91f465.js";import{u as B}from"./useVehicles-4e45c742.js";const V=()=>{var b;const[t,a]=o.useState(!1),{authInfo:n}=w(),{userList:l,refreshData:d}=O(),[c,v]=o.useState(null);o.useEffect(()=>{var f;if(n&&l){const u=l==null?void 0:l.filter(E=>{var N;return E._id===((N=n==null?void 0:n.auth)==null?void 0:N._id)});console.log(44,u),v((f=u[0])==null?void 0:f.full_name)}},[n]),console.log(21,n,l);const{show:r,ui:i}=A("ModalLayout-component-login"),p=C(),m=o.useRef(null),h=o.useRef(null);o.useEffect(()=>{const f=({target:u})=>{h.current&&(!t||h.current.contains(u)||m.current.contains(u)||a(!1))};return document.addEventListener("click",f),()=>document.removeEventListener("click",f)}),o.useEffect(()=>{const f=({keyCode:u})=>{!t||u!==27||a(!1)};return document.addEventListener("keydown",f),()=>document.removeEventListener("keydown",f)});const k=()=>{R({}),p(D)},g=()=>{r({title:"خروج از حساب",desc:"آیا قصد خروج از حساب کاربری خود را دارید؟",label_confirm:"بله, خارج شو!",label_cancel:"خیر",onConfirm:()=>k()})};return s("div",{className:"DropdownUser-component",children:[i,s(y,{ref:m,onClick:()=>a(!t),to:"#",children:[e("span",{className:"userTitle",children:c||((b=n==null?void 0:n.auth)==null?void 0:b.username)}),e("i",{className:"fa fa-user user-img"}),e("i",{className:" fa fa-angle-down "})]}),e("div",{ref:h,onFocus:()=>a(!0),onBlur:()=>a(!1),className:"profile-div",style:{display:t===!0?"block":"none"},children:s("ul",{children:[!1,e("li",{children:s("button",{onClick:g,children:[e("i",{className:"fa fa-sign-out"}),e("span",{children:"خروج"})]})})]})})]})};const q=()=>e("header",{className:"bg-primary header-component",children:s("div",{className:"row header-div",children:[e("div",{className:"col-12 col-md-10 flex-right",children:e(y,{to:"/",children:e("span",{className:"titlepage",children:" سامانه ی جامع حمل و نقل شهرداری زرقان"})})}),!1,e("div",{className:"col-2 d-block d-md-none"}),e("div",{className:"col-10 col-md-2 flex-end",children:e(V,{})})]})});const $=({children:t,activeCondition:a})=>{const[n,l]=o.useState(a);return e("li",{children:t(()=>{l(!n)},n)})},_=()=>{const t=F(),a=T(),{pathname:n}=a;o.useRef(null);const l=o.useRef(null),d=localStorage.getItem("sidebar-expanded"),[c,v]=o.useState(d===null?!1:d==="true");return o.useEffect(()=>{var r,i;localStorage.setItem("sidebar-expanded",c.toString()),c?(r=document.querySelector("body"))==null||r.classList.add("sidebar-expanded"):(i=document.querySelector("body"))==null||i.classList.remove("sidebar-expanded")},[c]),e("div",{className:"sidebar-component",children:e("aside",{ref:l,children:e("ul",{children:t==null?void 0:t.map(r=>{if(r.label!="")return r.is_title?e("h3",{children:r.label},r.key):r.sub_menu==null?e("li",{children:s(y,{to:r.href,children:[s("i",{children:[r.icon," "]}),s("span",{children:[" ",r.label," "]})]})},r.key):e("ul",{children:e($,{activeCondition:n==="/"||n.includes("dashboard"),children:(i,p)=>{var m;return s(G.Fragment,{children:[s(y,{to:"#",onClick:h=>{h.preventDefault(),c?i():v(!0)},children:[r.icon,r.label]}),e("div",{children:e("ul",{children:(m=r.sub_menu)==null?void 0:m.map(h=>e("li",{children:s(y,{to:h.href,children:[h.icon,h.label]})},h.key))})})]})}})},r.key)})})})})};const J=()=>e("main",{className:"main-component",children:e(M,{})});function K(){return e(x,{})}function Q({vehicleID:t}){o.useState({latitude:null,longitude:null});const a=o.useRef(null),n=d=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(c=>{const{latitude:v,longitude:r}=c.coords;l(v,r,null,t)},c=>{console.error("Error getting location: ",c)}):console.error("Geolocation is not supported by this browser.")};function l(d,c,v,r){try{const i=H("http://127.0.0.1:4000",{reconnectionDelayMax:1e4,autoConnect:!0,path:"/api/v2/socket",auth:{token:localStorage.getItem("bearer_token")}});i.on("connect",()=>{let p=[];p.push({lat:d,lng:c,ownerID:r});const m="event-gps-update";i.emit(m,JSON.stringify(p))}),i.on("disconnect",()=>{console.log("Disconnected from server")})}catch(i){console.error("Error in sendFakeLocations:",i)}}return o.useEffect(()=>(a.current=setInterval(()=>{try{n([t])}catch(d){console.error("Error in sendCurrentLocationToServer:",d)}},15e3),()=>{a.current&&(clearInterval(a.current),a.current=null)}),[]),null}const I=()=>{var k;const[t,a]=o.useState(!1),{authInfo:n}=w(),{vehicles:l}=B(),d=C();o.useState(!1);const[c,v]=o.useState(void 0),[r,i]=o.useState(void 0);o.useEffect(()=>{var g,b,f;if(n!=null&&n.auth==null)d(D);else{try{i((b=(g=n==null?void 0:n.auth)==null?void 0:g.roles)==null?void 0:b.some(u=>u.title===P))}catch{i(void 0)}try{const u=(f=l==null?void 0:l.docs)==null?void 0:f.find(E=>{var N,L;return((N=E.driver_user)==null?void 0:N.id)===((L=n==null?void 0:n.auth)==null?void 0:L._id)});v(u?u._id:void 0)}catch{v(void 0)}}},[n,l,d]);const[p,m]=o.useState(null);return o.useEffect(()=>{var g,b;p&&((g=n==null?void 0:n.auth)!=null&&g._id)&&p.userIDs===((b=n==null?void 0:n.auth)==null?void 0:b._id)&&U.showSuccess(p.massage)},[p,(k=n==null?void 0:n.auth)==null?void 0:k._id]),j({listeners:{sendNotification:g=>{m(g)}}}),(n==null?void 0:n.auth)==null?e(z,{}):e(x,{children:s("div",{className:"container-fluid DefaultLayout-component",children:[e("div",{className:"row row-header",children:s("div",{className:"col-12",children:[e("i",{onClick:()=>a(!t),className:"button-bars fa fa-bars d-block d-sm-none"}),s(S,{children:[" ",e(q,{})," "]})]})}),s("div",{className:"row have-sidebar",children:[e("div",{className:"col-8 handleShowSidebar",style:{display:t===!0?"block":"none"},children:s(S,{children:[e(_,{})," "]})}),e("div",{className:"col-3 d-none d-sm-block",children:e(S,{children:e(_,{})})}),s("div",{className:"col-12 col-md-9",children:[c&&e(Q,{vehicleID:c}),s(S,{children:[e(J,{})," "]})]})]}),e("div",{className:"row",children:e("div",{className:"col-12",children:s(S,{children:[" ",e(K,{})]})})})]})})};export{I as default};
