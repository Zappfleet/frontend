import{r as l,x as ie,u as ae,a5 as le,D as ce,a as oe,C as re,f as P,b as e,j as a,b5 as de,b6 as me,b7 as he,b8 as fe,b9 as ue,ba as _e,R as pe,v as ve,b1 as Ee,l as Te,F as V,b2 as Ne,b3 as be,b4 as ge,w as De}from"./index-a6150745.js";import{u as Ce}from"./useItemSetToggle-8cfcb24a.js";import{e as x}from"./comments-4f6f4135.js";import{C as ye}from"./Comments-28f160d8.js";import{u as Ie}from"./useComments-08a326de.js";function H(n,T){const[h,_]=l.useState(null),[d,f]=l.useState({in_progress:!1});function N(){f({...d,in_progress:!0}),ie().getMissions_by_StatusAndDriverID(n,T).then(u=>{_(u.data)}).catch(u=>{console.error(6001,"Error fetching mission list:",u)}).finally(()=>{f({...d,in_progress:!1})})}return l.useEffect(()=>{N()},[]),{missionList:h,state:d,refreshData:N}}function Me(n={}){var M;const[T,h]=l.useState(!1),[_,d]=l.useState(!1),[f,N]=l.useState(null),[u,w]=l.useState(null),[R,$]=l.useState(""),[G,U]=l.useState(null),[Y,O]=l.useState(!1),[A,J]=l.useState(null),{authInfo:p}=ae(),{result:v,refreshData:Se}=Ie(Y,R,A,G);l.useEffect(()=>{p&&(p.auth.roles[0].title===le&&(N("driver"),w(p.auth._id)),p.auth.roles[0].title===ce&&(N("passenger"),w(p.auth._id)))},[p]);const z=oe(),{mode:K}=n,Q="",{requests:S}=re({mode:K,initialParams:{status:Q}}),{items:W,toggleItem:Z}=Ce({onlyOne:!0}),{missionList:j}=H("DRAFT",null),{missionList:E}=H("DONE",null),q=s=>{const i=s.locations.map(c=>({lat:c.coordinates[0],lng:c.coordinates[1],...c.meta})),t={_id:s._id,service:s.service,datetime:[s.gmt_for_date],...s.details};z("/passenger/new",{state:{type:"update",mode:"user-only",initialLocations:i,initialValues:t,className:"!top-12",submitted_by:s.submitted_by}})},ee=s=>(j.map(i=>{if(!i.driver_id&&i.service_requests&&i.service_requests.length>0&&i.service_requests.some(t=>t.request_id===s))return!0}),!1),se=(s,i)=>{d(!1),U(s),$("insert"),O(!0)};l.useEffect(()=>{var s,i;if(v){if(R==="insert"&&(v.status===200?(P.showSuccess("نظرات ثبت شد"),h(!1)):P.showError("اطلاعات ثبت نشد")),R==="select"){let t=!0;(i=(s=v==null?void 0:v.data)==null?void 0:s.data)==null||i.map(c=>{c.registerID===u&&(t=!1)}),h(t)}O(!1)}},[v]);const te=s=>{var b,g;const i=E==null?void 0:E.filter(o=>{var m;return o.service_requests&&((m=o.service_requests[0])==null?void 0:m.request_id)===s}),t=i&&((g=(b=i[0])==null?void 0:b.extra)!=null&&g.comments)?i[0].extra.comments:void 0,c=t==null?void 0:t.map(o=>{var m,D,C,y;return a(V,{children:[e("div",{className:"com0",children:e("span",{className:"title",children:`نظر ${o.role==="driver"?"راننده":"مسافر"}`})}),a("div",{className:"com1",children:[e("i",{style:{color:(m=x.find(r=>r.key===o.emojiID))==null?void 0:m.color},className:(D=x.find(r=>r.key===o.emojiID))==null?void 0:D.icon}),e("span",{children:(C=x.find(r=>r.key===o.emojiID))==null?void 0:C.value})]}),e("div",{className:"com2",children:e("p",{children:o.customComment})}),e("div",{className:"com3",children:(y=o.comments)==null?void 0:y.map(r=>e("span",{className:r.type,children:r.value}))})]})});return c?e("div",{className:"request-mycomment",children:a("div",{className:"row",children:[e("div",{className:"col-2 title",children:"نظرات"}),e("div",{className:"col-10",children:c})]})}):null},ne=s=>{J(s),d(!0)};return e("div",{className:"RequestHistory-component",children:e("div",{className:"row",children:e("div",{className:"col-12 have-table",children:a("table",{className:"table table-hover",children:[e("thead",{children:a("tr",{children:[e("th",{children:de}),e("th",{children:me}),e("th",{children:he}),e("th",{children:fe}),e("th",{children:ue}),e("th",{children:_e}),e("th",{children:""})]})}),e("tbody",{children:j&&((M=S==null?void 0:S.docs)==null?void 0:M.map(s=>{var o,m,D,C,y,r,k,L,X,B;let i=s.status==="PENDING"||s.status==="CONFIRM"?!0:s.status==="ASSIGNED_TO_MISSION"?ee(s._id):!1;const t=E==null?void 0:E.filter(I=>{var F;return I.service_requests&&((F=I.service_requests[0])==null?void 0:F.request_id)===s._id&&I.status==="DONE"}),c=t&&((m=(o=t[0])==null?void 0:o.extra)!=null&&m.comments)?t[0].extra.comments:void 0;let b=!0;c==null||c.map(I=>{I.registerID===u&&(b=!1)});const g=W.includes(s._id);return a(pe.Fragment,{children:[a("tr",{children:[a("td",{children:[ve(s.gmt_for_date),i===!0&&e("i",{onClick:()=>q(s),className:"fa fa-pencil pencil "}),b===!0&&t&&t[0]&&((D=t[0])==null?void 0:D.status)==="DONE"&&e("i",{onClick:()=>ne(t[0]._id),className:"fa fa-comment pencil "}),_&&A===((C=t[0])==null?void 0:C._id)&&a("div",{className:"div-comments",children:[e("i",{onClick:()=>d(!1),className:"close-icon fa fa-remove"}),e(ye,{registerID:u,registerRole:f,saveComment:se})]})]}),e("td",{children:((y=s.submitted_by)==null?void 0:y.full_name)||((r=s.submitted_by)==null?void 0:r.username)}),e("td",{children:((k=s.confirmed_by)==null?void 0:k.full_name)||((L=s.confirmed_by)==null?void 0:L.username)}),e("td",{children:t&&t[0]?Object.fromEntries(Ee)[t[0].status]:Object.fromEntries(Te)[s.status]}),e("td",{children:t&&t[0]&&t[0].driver_full_name}),e("td",{children:((X=s.details)==null?void 0:X.desc)&&((B=s.details)==null?void 0:B.desc)}),e("td",{onClick:()=>Z(s._id),children:e("i",{className:`fa ${g?"fa-angle-down":"fa-angle-up"}`})})]}),e("tr",{style:{display:g?"contents":"none"},children:e("td",{colSpan:6,children:e("div",{className:"expand",children:a("div",{children:[e(Re,{request:s}),te(s._id)]})})})})]},s._id)}))})]})})})})}function Re({request:n}){var T,h,_;return e("table",{children:a("tbody",{children:[a("tr",{children:[e("td",{className:"name",children:Ne}),e("td",{children:((T=n==null?void 0:n.details)==null?void 0:T.proj_code)&&((h=n==null?void 0:n.details)==null?void 0:h.proj_code)})]}),a("tr",{children:[e("td",{className:"name",children:be}),e("td",{children:((_=n==null?void 0:n.details)==null?void 0:_.cost_center)&&n.details.cost_center})]}),a("tr",{children:[e("td",{className:"name",children:ge}),e("td",{children:e("ul",{children:n.locations.map(({meta:d},f)=>e(V,{children:a("li",{children:[e("span",{children:` ${De(n.locations.length,f)} `}),d.address]},f)}))})})]})]})})}export{Me as R};
