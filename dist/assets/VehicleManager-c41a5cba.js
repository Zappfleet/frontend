import{n as he,r as d,aN as me,aO as pe,aP as ge,aQ as ve,aR as fe,c as r,F as C,j as t,ao as h,a0 as o,aD as _e,aS as be,H as ye,aM as Ee,a1 as _,aT as U,aU as xe,a2 as j,aV as Ne,aW as Ce,y as ke,f as F,aX as Se,av as m,au as Ie,aY as Te}from"./index-4b638fea.js";import{u as we}from"./useVehicles-4e45c742.js";import{u as Pe}from"./useVehicleBasicData-dc6e97f6.js";import{P as O}from"./PlaqueInput-aecdb007.js";import{S as De}from"./SimpleButton-b66aa1df.js";import{u as Re,S as Le}from"./SuggestionTextInput-de8ae0dd.js";import{T as Ve}from"./TabbedPanel-861d1946.js";const B=()=>({temp_id:new Date().getTime(),service:o,capacity:0}),H=()=>({group:"-",plaque:{serial:"",threeDigit:"",character:"",twoDigit:""},services:[B()],extras:{name:"-",color:"-"}}),ze=()=>{var D,R,L,V,M,A,q;const{hasPermitGroup:Me,hasPermitFor:p,hasAdminRank:Ae,permits:qe}=he();d.useState(!1);const[v,G]=d.useState(!1),[$,Y]=d.useState(!1),[Ue,z]=d.useState(!1),[je,K]=d.useState(!1);d.useEffect(()=>{G(p([me])),Y(p([pe])),z(p([ge])),K(p([ve]))},[p]);const Q=d.useRef(),g=d.useRef(),{data:c}=Pe({include_inactive:!1}),{refreshData:W}=Re({permissions:[fe],include_external_base:!1}),b=d.useRef(),[a,i]=d.useState(H()),[u,k]=d.useState({}),{vehicles:y,refreshVehicles:S}=we(),X=e=>{e.preventDefault();const n={...a};n.services.push(B()),i(n)},J=e=>{b.current=e.key,S({type:e.key}),E()},Z=(e,n)=>{const s={...a};s.services.find(({temp_id:l})=>l==e.temp_id).capacity=parseInt(n.target.value),i(s)},ee=(e,n)=>{const s={...a};s.services.find(({temp_id:l})=>l==e.temp_id).service=n.target.value,i(s)},re=e=>{const n={...a};n.services=n.services.filter(({temp_id:s})=>s!=e.temp_id),i(n)},I=e=>{const n={...a};n.extras[e.target.name]=e.target.value,i(n)},ae=e=>{const n={...a};n.group=e.target.value,i(n)},ne=e=>{i({...a,plaque:e})},se=()=>{var s,l;const e={};return(a.agency_name==null||((s=a.agency_name)==null?void 0:s.trim().length)==0)&&(e.agency_name=m),(a.agency_phone==null||((l=a.agency_phone)==null?void 0:l.trim().length)==0)&&(e.agency_phone=m),k(e),Object.keys(e).length>0},te=()=>{const e={};return a.group==o&&(e.group=m),Object.entries(a.plaque).map(([l,f])=>f).includes(Ce)&&(e.plaque=m),a.services.length==0&&(e.services=Ie),a.services.find(l=>l.service==o||l.capacity==0||l.capacity==null)!=null&&(e.services=Te),a.extras.name==o&&(e["extras.name"]=m),a.extras.color==o&&(e["extras.color"]=m),k(e),Object.keys(e).length>0},T=e=>{i({...a,[e.target.name]:e.target.value})},E=()=>{var e;i(H()),(e=g==null?void 0:g.current)==null||e.resetToDefaults()},w=(e,n)=>{ke()[e](n,a._id).then(()=>{F.showSuccess(Se),E(),S({type:b.current})}).catch(s=>{F.showError(s.message)})},le=e=>{if(e.preventDefault(),se())return;const s={agency_name:a.agency_name,agency_phone:a.agency_phone},l=a._id==null?"insertAgency":"updateAgency";w(l,s)},ce=e=>{var f;if(e.preventDefault(),te())return;const s={group:a.group,plaque:Ne(a.plaque),services:a.services,extra:a.extras,driver_user:(f=a.driver)==null?void 0:f._id},l=a._id==null?"insertVehicle":"updateVehicle";w(l,s)};function x(e,n){var s;return n?((s=n.find(l=>l.key==e))==null?void 0:s.title)||e:""}async function ie(e){return new Promise((n,s)=>W(e).then(n).catch(s))}function oe(e){i({...a,driver:e})}function de(){i({...a,driver:null})}function N(){return b.current==U}function P(e){if(N()){const n={_id:e._id,agency_name:e.extra.agency_name,agency_phone:e.extra.agency_phone};i(n)}else{const n={_id:e._id,group:e.group,plaque:j(e.plaque),services:e.services.map(s=>({...s})),extras:{...e.extra},driver:e.driver_user};g.current.setValues(n.plaque),i(n)}}function ue(){return N()?t(C,{children:[r("th",{children:"نام آژانس"}),r("th",{children:"تلفن"})]}):t(C,{children:[r("th",{children:"گروه"}),r("th",{children:"وضعیت"}),r("th",{children:"پلاک"}),r("th",{children:"سرویس ها"}),r("th",{children:"راننده"}),r("th",{children:"جزئیات"})]})}return r(C,{children:r("div",{className:"VehicleManager-component",children:t("div",{className:"row",children:[r("div",{className:"col-12 col-md-4 order-2 order-md-1",children:t("div",{className:"right",children:[a._id!=null&&r("i",{className:" fa fa-remove close-icon",onClick:E}),r("form",{ref:Q,children:r(Ve,{onTabChange:J,tabs:[{label:"سازمانی",key:"org",component:t("div",{children:[t("div",{className:"mb-4",children:[t("label",{className:"mb-2.5 block font-medium text-black dark:text-white",children:["گروه",r(h,{message:u.group})]}),r("div",{className:"relative flex items-center justify-center",children:t("select",{value:a.group,onChange:ae,className:"select-box w-full",children:[r("option",{disabled:!0,value:o,children:o}),(D=c==null?void 0:c.groups)==null?void 0:D.map(e=>r("option",{value:e.key,children:e.title},e.key))]})})]}),t("div",{children:[t("label",{className:"mb-2.5 block font-medium text-black dark:text-white",children:["پلاک",r(h,{message:u.plaque})]}),r(O,{inputRef:g,onChange:ne})]}),t("div",{className:"mb-2 p-2 shadow",children:[t("label",{className:"mb-2.5 block font-medium text-black dark:text-white",children:["راننده",r(h,{message:u.driver})]}),r(Le,{onSuggestionSelected:oe,placeholder:"جستجوی راننده ها ...",readFromDataSource:ie,suggestionRenderer:e=>r("div",{className:"px-4 py-1",children:e.full_name})}),r("div",{className:"mb-2 h-8",children:a.driver==null?r("label",{className:"block w-full text-center text-sm",children:"راننده انتخاب نشده"}):t("div",{className:"item-center flex justify-between rounded p-2 shadow",children:[r("span",{children:`${a.driver.full_name}`}),r(_e,{onClick:de,className:"cursor-pointer hover:text-danger",size:24})]})})]}),t("div",{className:"mb-4 rounded p-2 shadow",children:[t("label",{className:"mb-2.5 block font-medium text-black dark:text-white",children:["سرویس های خودرو",r(h,{message:u.services})]}),t(De,{onClick:X,children:["افزودن سرویس",r(be,{size:24,className:"mr-2"})]}),(R=a.services)==null?void 0:R.map(e=>{var n;return t("div",{className:"mt-3 flex items-center p-2 shadow",children:[r(ye,{onClick:()=>re(e),className:"ml-1 cursor-pointer hover:text-danger",size:24}),t("select",{onChange:s=>ee(e,s),value:e.service,className:"select-box w-full flex-1",children:[r("option",{disabled:!0,value:o,children:o}),(n=c==null?void 0:c.services)==null?void 0:n.map(s=>r("option",{value:s.key,children:`${s.title} (${Object.fromEntries(Ee)[s.unit]||"نامشخص"})`},s.key))]}),r("input",{onChange:s=>Z(e,s),value:e.capacity||"",className:"mr-2 w-24 rounded border border-gray px-2 outline-none",placeholder:"ظرفیت ..."})]},e.temp_id)})]}),t("div",{className:"mx-1 mb-4 flex-1",children:[t("label",{className:"mb-2.5 block font-medium text-black dark:text-white",children:["مدل خودرو",r(h,{message:u["extras.name"]})]}),r("div",{className:"relative flex items-center justify-center",children:t("select",{name:"name",onChange:e=>I(e),value:(L=a.extras)==null?void 0:L.name,className:"select-box w-full",children:[r("option",{disabled:!0,value:o,children:o}),(V=c==null?void 0:c.names)==null?void 0:V.map(e=>r("option",{value:e.key,children:e.title},e.key))]})})]}),t("div",{className:"mx-1 mb-4 flex-1",children:[t("label",{className:"mb-2.5 block font-medium text-black dark:text-white",children:["رنگ خودرو",r(h,{message:u["extras.color"]})]}),r("div",{className:"relative flex items-center justify-center",children:t("select",{name:"color",onChange:e=>I(e),value:(M=a.extras)==null?void 0:M.color,className:"select-box w-full",children:[r("option",{disabled:!0,value:o,children:o}),(A=c==null?void 0:c.colors)==null?void 0:A.map(e=>r("option",{value:e.key,children:e.title},e.key))]})}),t("div",{className:"mt-5",children:[v===!0&&r(_,{onClick:ce,className:"mt-3 w-full cursor-pointer  rounded-lg bg-primary p-2 text-white transition hover:bg-opacity-90",children:"ثبت خودرو"}),v===!1&&r(_,{disabled:!0,className:"NoPermission mt-3 w-full cursor-pointer  rounded-lg bg-primary p-2 text-white transition hover:bg-opacity-90",children:"ثبت خودرو"})]})]})]})},{label:"آژانس",key:U,component:t("div",{className:"m-2",children:[t("div",{children:[r("label",{className:"my-2 inline-block",children:"نام آژانس"}),r(h,{message:u.agency_name}),r("input",{value:a.agency_name||"",onChange:T,name:"agency_name",className:"w-full rounded border border-gray p-2 outline-none",placeholder:"نام آژانس"})]}),t("div",{className:"mt-2",children:[r("label",{className:"my-2 inline-block",children:"شماره تماس"}),r(h,{message:u.agency_phone}),r("input",{onChange:T,value:a.agency_phone||"",name:"agency_phone",className:"w-full rounded border border-gray p-2 outline-none",placeholder:"تلفن آژانس"})]}),t("div",{className:"mt-5",children:[v===!0&&r(_,{onClick:le,className:"mt-3 w-full cursor-pointer  rounded-lg bg-primary p-2 text-white transition hover:bg-opacity-90",children:"ثبت آژانس"}),v===!1&&r(_,{disabled:!0,className:"NoPermission mt-3 w-full cursor-pointer  rounded-lg bg-primary p-2 text-white transition hover:bg-opacity-90",children:"ثبت آژانس"})]})]})}]})})]})}),r("div",{className:"col-12 col-md-8 order-1 order-md-2",children:r("div",{className:"left",children:t("table",{className:"table table-hover table-striped",children:[r("thead",{children:r("tr",{children:ue()})}),r("tbody",{children:(q=y==null?void 0:y.docs)==null?void 0:q.map(e=>{var n;return N()?t("tr",{onClick:()=>{$===!0&&P(e)},children:[r("td",{children:e.extra.agency_name}),r("td",{children:e.extra.agency_phone})]},e._id):t("tr",{onClick:()=>P(e),children:[r("td",{children:x(e.group,c.groups)}),r("td",{children:Object.fromEntries(xe)[e.status]}),r("td",{children:r(O,{small:!0,disabled:!0,value:j(e.plaque)})}),r("td",{children:e.services.map(s=>r("span",{children:`${x(s.service,c.services)} (${s.capacity})`}))}),r("td",{children:(n=e.driver_user)==null?void 0:n.full_name}),r("td",{children:Object.entries(e.extra).map(([s,l])=>r("span",{children:x(l,c[`${s}s`])}))})]},e._id)})})]})})})]})})})};export{ze as default};
