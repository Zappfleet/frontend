import{u as ae,r as i,a5 as re,D as ie,a6 as X,a7 as W,f as I,b as o,j as N,a8 as ce,h as le,a0 as oe,w as ue,x as z,a9 as H,aa as de,a4 as he,S as fe,ab as me,ac as ge}from"./index-a6150745.js";import{N as pe,M as _e}from"./MapContainer-4d9f8ebf.js";import{g as Se,c as Ce}from"./carIcon-581ea059.js";import{B as we}from"./BottomSheetModal-e5567c0c.js";import{U as Ne}from"./user-03-3459d852.js";import{r as C}from"./renderUi-054e105a.js";import{C as ye}from"./Comments-28f160d8.js";import{u as be}from"./useComments-08a326de.js";import"./useSocket-8b3223ec.js";import"./useVehicles-13ecc312.js";import"./comments-4f6f4135.js";const ve=d=>{var O,k,s,f,_,m;const{authInfo:c}=ae(),[w,y]=i.useState(""),[v,L]=i.useState(null),[S,M]=i.useState(!1),[h,l]=i.useState(!1),{result:p,refreshData:b}=be(S,w,d.mission_id,v),[R,E]=i.useState(null),[t,P]=i.useState(null);i.useEffect(()=>{c&&(c.auth.roles[0].title===re&&(E("driver"),P(c.auth._id)),c.auth.roles[0].title===ie&&(E("passenger"),P(c.auth._id)))},[c]);const[x,K]=i.useState({open:!1}),e=d.serviceItem,V=()=>{K({...x,open:!x.open})};i.useEffect(()=>{const n=setTimeout(()=>{d.onStateChanged&&d.onStateChanged(x)},350);return()=>{clearTimeout(n)}},[x]);const T=(e==null?void 0:e.status)==X,Z=(e==null?void 0:e.status)!=W&&e.current_location_index<((O=e==null?void 0:e.request)==null?void 0:O.locations.length)-1,Y=(e==null?void 0:e.status)==W,q=(k=e==null?void 0:e.request)==null?void 0:k.locations.length,[J,D]=i.useState(!1),j=()=>{D(!0)};i.useEffect(()=>{T===!0&&(y("select"),M(!0))},[T]);const F=n=>{D(!1),L(n),y("insert"),M(!0)};i.useEffect(()=>{var n,u;if(p){if(w==="insert"&&(p.status===200?(I.showSuccess("نظرات ثبت شد"),l(!1)):I.showError("اطلاعات ثبت نشد")),w==="select"){let a=!0;(u=(n=p==null?void 0:p.data)==null?void 0:n.data)==null||u.map(r=>{console.log(5,r.registerID,t),r.registerID===t&&(a=!1)}),l(a)}M(!1)}},[p]);const G=n=>{window.location.href=`tel:${n}`};return o("div",{className:"DriverMissionServiceItem-component",children:N("div",{className:"border-b border-gray-4 p-2",children:[N("div",{className:"flex items-center relative",children:[o("img",{className:"relative h-8 w-8 rounded-full",src:Ne,alt:"User"}),o("label",{className:"px-2",children:e==null?void 0:e.request.submitted_by.full_name}),o("i",{className:"fa fa-phone icon-phone",onClick:()=>{var n,u;return G((u=(n=e==null?void 0:e.request)==null?void 0:n.submitted_by)==null?void 0:u.phone)}}),o(ce,{onClick:V,size:40,className:"absolute left-0 rounded-full p-2 cursor-pointer"})]}),o("p",{className:"py-3 px-4 text-primary text-sm",children:`توضیحات : ${(s=e==null?void 0:e.request.details)==null?void 0:s.desc}`}),N("div",{className:le("overflow-hidden duration-300 mx-1 whitespace-nowrap",{"h-20 py-2 ":x.open,"h-0 py-0 ":!x.open}),children:[C(o("label",{className:"bold",children:"ایستگاه اول : "})).if(e.current_location_index==-1),C(o("label",{className:"bold",children:"ایستگاه بعد : "})).if(e.current_location_index>-1&&e.current_location_index!=q-2),C(o("label",{className:"bold",children:"ایستگاه آخر : "})).if(e.current_location_index==q-2),C(o("label",{className:"whitespace-nowrap",children:((m=(_=(f=e==null?void 0:e.request)==null?void 0:f.locations[e.current_location_index+1])==null?void 0:_.meta)==null?void 0:m.address)||"DD"})).if(e.current_location_index<q-1),N("div",{className:"flex justify-end",children:[N(oe,{onClick:()=>{T||d==null||d.handleServiceItemProgress(e)},isLoading:!1,className:"bg-primary text-white rounded-2xl px-2 py-1 mt-2",children:[C("حرکت به سمت مبدا").if(Y),C(`به ایستگاه ${ue(q,e.current_location_index+1)} رسیدم`).if(Z),C("سرویس پایان یافت").if(T)]}),h&&o("button",{onClick:j,className:"my-btn",children:" ثبت نظر"}),J&&N("div",{className:"div-comments",children:[o("i",{onClick:()=>D(!1),className:"close-icon fa fa-remove"}),o(ye,{registerID:t,registerRole:R,saveComment:F})]})]})]})]})})};function xe(d){switch(d){case H:return"on-route";default:return d.toLocaleLowerCase()}}function Me(d){const[c,w]=i.useState();i.useEffect(()=>{z().getMissionDetails(d.mission_id).then(({data:h})=>{w(h)}).catch(console.log)},[d.mission_id]);function y(h){return c.mission.service_requests.find(({request:l})=>l.id==h._id)}function v(){w({...c})}async function L(h){if(c!=null)try{const{data:l}=await z().updateMissionStatus(c.mission._id,xe(h)),{mission:p,history_entry:b}=l,R={...c.mission};return R.status=h,w({mission:R}),{mission:p}}catch(l){return console.log(l),{error:l}}}async function S(h){try{await z().setMissionRequestOnRoute(c.mission._id,h._id);const l=y(h);return console.log({serviceRequest:l}),l.status=H,v(),c}catch(l){console.log(l)}}async function M(h,l){var p;try{await z().setMissionRequestCurrentLocation(c.mission._id,h._id,l);const b=y(h);return b.current_location_index=l,((p=b==null?void 0:b.request)==null?void 0:p.locations.length)-1==l&&(b.status=X),v(),c}catch(b){console.log(b)}}return{updateMissionStatus:L,initMissionRequest:S,proceedMissionRequest:M,data:c}}const Re=({locations:d})=>o("div",{className:"mapRouting-component",children:o("button",{className:"my-btn",children:o("a",{className:"my-link",href:(()=>{const w="https://www.google.com/maps/dir/",y=d.map(v=>`${v[1]},${v[0]}`).join("/");return`${w}${y}/@35.188554,-115.294222,6z/data=!3m1!4b1?entry=ttu`})(),target:"_blank",rel:"noopener noreferrer",children:"مسیریابی"})})}),Pe=()=>{var j,F,G,O,k;const[d,c]=i.useState([]),[w]=de(),y=w.get("mission_id"),[v,L]=i.useState(""),S=i.useRef(),[M,h]=i.useState(!1),[l,p]=i.useState(null),[b,R]=i.useState(null);Se(M,l,S,Ce,.015);const E=i.useRef(),{data:t,updateMissionStatus:P,initMissionRequest:x,proceedMissionRequest:K}=Me({mission_id:y}),e=s=>{E.current=s},V=()=>{t!=null&&E.current.show()};i.useEffect(()=>{navigator.geolocation.getCurrentPosition(s=>{},()=>{})},[]),i.useEffect(()=>{var s,f,_,m,n,u,a,r,g,U,A,Q;if(t){((s=t==null?void 0:t.mission)==null?void 0:s.status)==="DONE"&&L("DONE"),((f=t==null?void 0:t.mission)==null?void 0:f.status)==="ON_ROUTE"&&(console.log(53),R("driver"),p([(m=(_=t==null?void 0:t.mission)==null?void 0:_.vehicle)==null?void 0:m.id]),h(!0));let B=[];const ne=(r=(a=(u=(n=t==null?void 0:t.mission)==null?void 0:n.service_requests[0])==null?void 0:u.request)==null?void 0:a.locations)==null?void 0:r.length;(Q=(A=(U=(g=t==null?void 0:t.mission)==null?void 0:g.service_requests[0])==null?void 0:U.request)==null?void 0:A.locations)==null||Q.map(($,ee)=>{var te,se;B.push([$.coordinates[1],$.coordinates[0]]),ee===0||ee===ne-1?(te=S.current)==null||te.addMarker($.coordinates[1],$.coordinates[0],!0,void 0,null,{color:"rgba(255, 0, 0, 1)"}):(se=S.current)==null||se.addMarker($.coordinates[1],$.coordinates[0],!0,void 0,null,{color:"rgba(0, 255, 0, 1)"})}),T(B)}},[t]);const T=async s=>{c(s),console.log(52,s);let f,_,m="";const n=s==null?void 0:s.length;s.map((a,r)=>{r===0?f=`${a[1]},${a[0]}`:r===n-1?_=`${a[1]},${a[0]}`:n>2&&r===1?m+=`${a[1]},${a[0]}`:m+=`%7C${a[1]},${a[0]}`});const u=`https://api.neshan.org/v4/direction?type=car&origin=${f}&destination=${_}&waypoints=${m}&avoidTrafficZone=false&avoidOddEvenZone=false&alternative=false&bearing`;console.log(66,u),await he.get(u,{headers:{"Api-Key":pe}}).then(a=>{var g;console.log("API response:",a);const r=Y(a.data,s[n-1]);console.log(253,r),(g=S==null?void 0:S.current)==null||g.addRoute(r,!0,"255, 0, 0")}).catch(a=>{console.error("Error fetching data:",a)})};function Z(s){let f=0;const _=s.length;let m=0,n=0;const u=[];for(;f<_;){let a=0,r=0,g;do g=s.charCodeAt(f++)-63,r|=(g&31)<<a,a+=5;while(g>=32);const U=r&1?~(r>>1):r>>1;m+=U,a=0,r=0;do g=s.charCodeAt(f++)-63,r|=(g&31)<<a,a+=5;while(g>=32);const A=r&1?~(r>>1):r>>1;n+=A,u.push([m*1e-5,n*1e-5])}return u}const Y=(s,f)=>{var _,m;try{const n=s.routes;console.log(400,n);let u=[];n&&n.length>0&&((_=n[0].legs)==null||_.map((a,r)=>{var g;(g=a.steps)==null||g.map((U,A)=>{Z(U.polyline).map(B=>{u.push([B[1],B[0]])})})}),console.log(4589,u),(m=S.current)==null||m.addRoute(u,!0,"0, 0, 255"))}catch(n){console.error("Error extracting route coordinates:",n)}return null},q=({open:s})=>{s&&E.current.scrollToMax()},J=async()=>{const{mission:s}=await P(H);s==null&&I.showError("خطا در شروع سفر"),s!=null&&I.showSuccess("سفر شروع شد")},D=async s=>{s.status==W?x(s.request):K(s.request,s.current_location_index+1)};return o("div",{className:"DriverCurrentMissionService-component",children:N("div",{className:"div",children:[o("div",{className:"row",children:o("div",{className:"col-12",children:N("div",{className:"location-div",children:[o(_e,{mapRef:S}),o(Re,{locations:d})]})})}),o("div",{className:"fixed bottom-0 left-0 right-0 flex p-1 z-999999 justify-center",children:N("button",{onClick:V,className:"fixed left-4 bottom-4 bg-primary rounded-full w-16 h-16 flex justify-center items-center",children:[C(o(fe,{})).if(t==null),C(o(me,{className:"text-white",size:30})).if(t!=null)]})}),o(we,{onCreate:e,children:N("div",{children:[N("div",{className:"flex justify-center pb-2",children:[C(o(oe,{onClick:J,className:"w-full",children:"شروع سفر"})).if(((j=t==null?void 0:t.mission)==null?void 0:j.status)==ge),C(o("label",{children:"سفر پایان یافته"})).if(((F=t==null?void 0:t.mission)==null?void 0:F.status)==X),C(o("label",{children:"سفر شروع شده"})).if(((G=t==null?void 0:t.mission)==null?void 0:G.status)==H)]}),(k=(O=t==null?void 0:t.mission)==null?void 0:O.service_requests)==null?void 0:k.map((s,f)=>o(ve,{mission_id:y,serviceItem:s,handleServiceItemProgress:D,onStateChanged:q},f))]})})]})})};export{Pe as default};
