import{r as a,h as ue,u as _e,a6 as ge,D as pe,b as ve,G as be,f as Y,j as l,F as P,c as s,b5 as Ne,b6 as Ee,b7 as Te,b8 as Ce,b9 as De,ba as Se,R as ye,x as Re,b1 as Ie,n as xe,b2 as Oe,b3 as Me,b4 as ke,y as we}from"./index-0b0339af.js";import{u as Ae}from"./useItemSetToggle-41eb145a.js";import{e as j}from"./comments-4f6f4135.js";import{C as je}from"./Comments-f89e8dec.js";import{u as Pe}from"./useComments-5e918d22.js";function J(i,T){const[u,p]=a.useState(null),[h,_]=a.useState({in_progress:!1});function C(){_({...h,in_progress:!0}),ue().getMissions_by_StatusAndDriverID(i,T).then(g=>{p(g.data)}).catch(g=>{console.error(6001,"Error fetching mission list:",g)}).finally(()=>{_({...h,in_progress:!1})})}return a.useEffect(()=>{C()},[]),{missionList:u,state:h,refreshData:C}}function Ve(i={}){const[T,u]=a.useState(!1),[p,h]=a.useState(!1),[_,C]=a.useState(null),[g,L]=a.useState(null),[k,z]=a.useState(""),[K,Q]=a.useState(null),[W,F]=a.useState(!1),[X,Z]=a.useState(null),{authInfo:o}=_e(),{result:v,refreshData:Fe}=Pe(W,k,X,K),[b,w]=a.useState(1),x=30,[q,ee]=a.useState(30),[se,te]=a.useState(0),[N,ne]=a.useState([]);a.useEffect(()=>{var e,n,t,c;o&&(((n=(e=o==null?void 0:o.auth)==null?void 0:e.roles[0])==null?void 0:n.title)===ge&&(C("driver"),L(o==null?void 0:o.auth._id)),((c=(t=o==null?void 0:o.auth)==null?void 0:t.roles[0])==null?void 0:c.title)===pe&&(C("passenger"),L(o==null?void 0:o.auth._id)))},[o]);const ie=ve(),{mode:B}=i,{requests:r}=be({mode:B,initialParams:{status:"",paging:!1}}),{items:ae,toggleItem:le}=Ae({onlyOne:!0}),{missionList:O}=J("DRAFT",null),{missionList:E}=J("",null);a.useEffect(()=>{console.log(74,B,r),ee(b*x),te(b*x-x),(r==null?void 0:r.length)>0&&ne(r==null?void 0:r.slice(se,q))},[r,b]);const ce=e=>{const n=e.locations.map(c=>({lat:c.coordinates[0],lng:c.coordinates[1],...c.meta})),t={_id:e._id,service:e.service,datetime:[e.gmt_for_date],...e.details};ie("/passenger/new",{state:{type:"update",mode:"user-only",initialLocations:n,initialValues:t,className:"!top-12",submitted_by:e.submitted_by}})},oe=e=>(O==null||O.map(n=>{var t;if(!n.driver_id&&n.service_requests&&((t=n==null?void 0:n.service_requests)==null?void 0:t.length)>0&&n.service_requests.some(c=>c.request_id===e))return!0}),!1),re=(e,n)=>{h(!1),Q(e),z("insert"),F(!0)};a.useEffect(()=>{var e,n;if(v){if(k==="insert"&&(v.status===200?(Y.showSuccess("نظرات ثبت شد"),u(!1)):Y.showError("اطلاعات ثبت نشد")),k==="select"){let t=!0;(n=(e=v==null?void 0:v.data)==null?void 0:e.data)==null||n.map(c=>{c.registerID===g&&(t=!1)}),u(t)}F(!1)}},[v]);const de=e=>{var D,S;const n=E==null?void 0:E.filter(d=>{var f;return d.service_requests&&((f=d.service_requests[0])==null?void 0:f.request_id)===e}),t=n&&((S=(D=n[0])==null?void 0:D.extra)!=null&&S.comments)?n[0].extra.comments:void 0,c=t==null?void 0:t.map(d=>{var f,y,R,I;return l(P,{children:[s("div",{className:"com0",children:s("span",{className:"title",children:`نظر ${d.role==="driver"?"راننده":"مسافر"}`})}),l("div",{className:"com1",children:[s("i",{style:{color:(f=j.find(m=>m.key===d.emojiID))==null?void 0:f.color},className:(y=j.find(m=>m.key===d.emojiID))==null?void 0:y.icon}),s("span",{children:(R=j.find(m=>m.key===d.emojiID))==null?void 0:R.value})]}),s("div",{className:"com2",children:s("p",{children:d.customComment})}),s("div",{className:"com3",children:(I=d.comments)==null?void 0:I.map(m=>s("span",{className:m.type,children:m.value}))})]})});return c?s("div",{className:"request-mycomment",children:l("div",{className:"row",children:[s("div",{className:"col-2 title",children:"نظرات"}),s("div",{className:"col-10",children:c})]})}):null},me=e=>{Z(e),h(!0)},he=e=>{w(e)},A=(r==null?void 0:r.length)>0?Math.ceil(r.length/x):1,fe=Array.from({length:Math.min(A,9)},(e,n)=>n+1);return l(P,{children:[!r&&s("p",{children:"Loading..."}),r&&s("div",{className:"RequestHistory-component",children:s("div",{className:"row",children:(N==null?void 0:N.length)>0&&l("div",{className:"col-12 have-table",children:[l("table",{className:"table table-hover",children:[s("thead",{children:l("tr",{children:[s("th",{children:Ne}),s("th",{children:Ee}),s("th",{children:Te}),s("th",{children:Ce}),s("th",{children:De}),s("th",{children:Se}),s("th",{children:""})]})}),s("tbody",{children:O&&(N==null?void 0:N.filter(e=>i.requestID?e._id===i.requestID:!0).map(e=>{var d,f,y,R,I,m,H,$,G,V;let n=e.status==="PENDING"||e.status==="CONFIRM"?!0:e.status==="ASSIGNED_TO_MISSION"?oe(e._id):!1;const t=E==null?void 0:E.filter(M=>{var U;return M.service_requests&&((U=M.service_requests[0])==null?void 0:U.request_id)===e._id}),c=t&&((f=(d=t[0])==null?void 0:d.extra)!=null&&f.comments)?t[0].extra.comments:void 0;let D=!0;c==null||c.map(M=>{M.registerID===g&&(D=!1)});const S=ae.includes(e._id);return l(ye.Fragment,{children:[l("tr",{children:[l("td",{children:[Re(e.gmt_for_date),n===!0&&s("i",{onClick:()=>ce(e),className:"fa fa-pencil pencil "}),D===!0&&t&&t[0]&&((y=t[0])==null?void 0:y.status)==="DONE"&&s("i",{onClick:()=>me(t[0]._id),className:"fa fa-comment pencil "}),p&&X===((R=t[0])==null?void 0:R._id)&&l("div",{className:"div-comments",children:[s("i",{onClick:()=>h(!1),className:"close-icon fa fa-remove"}),s(je,{registerID:g,registerRole:_,saveComment:re})]})]}),s("td",{children:((I=e.submitted_by)==null?void 0:I.full_name)||((m=e.submitted_by)==null?void 0:m.username)}),s("td",{children:((H=e.confirmed_by)==null?void 0:H.full_name)||(($=e.confirmed_by)==null?void 0:$.username)}),s("td",{children:t&&t[0]?Object.fromEntries(Ie)[t[0].status]:Object.fromEntries(xe)[e.status]}),s("td",{children:t&&t[0]&&t[0].driver_full_name}),s("td",{children:((G=e.details)==null?void 0:G.desc)&&((V=e.details)==null?void 0:V.desc)}),s("td",{onClick:()=>le(e._id),children:s("i",{className:`fa ${S?"fa-angle-down":"fa-angle-up"}`})})]}),s("tr",{style:{display:S?"contents":"none"},children:s("td",{colSpan:6,children:s("div",{className:"expand",children:l("div",{children:[s(Le,{request:e}),de(e._id)]})})})})]},e._id)}))})]}),l("div",{className:"pagination",children:[s("button",{className:"pagination-button",onClick:()=>w(e=>Math.max(e-1,1)),disabled:b===1,children:"<"}),fe.map(e=>s("button",{className:`pagination-button ${e===b?"active":""}`,onClick:()=>he(e),children:e},e)),s("button",{className:"pagination-button",onClick:()=>w(e=>Math.min(e+1,A)),disabled:b===A,children:">"})]})]})})})]})}function Le({request:i}){var T,u,p;return s("table",{children:l("tbody",{children:[l("tr",{children:[s("td",{className:"name",children:Oe}),s("td",{children:((T=i==null?void 0:i.details)==null?void 0:T.proj_code)&&((u=i==null?void 0:i.details)==null?void 0:u.proj_code)})]}),l("tr",{children:[s("td",{className:"name",children:Me}),s("td",{children:((p=i==null?void 0:i.details)==null?void 0:p.cost_center)&&i.details.cost_center})]}),l("tr",{children:[s("td",{className:"name",children:ke}),s("td",{children:s("ul",{children:i.locations.map(({meta:h},_)=>s(P,{children:l("li",{children:[s("span",{children:` ${we(i.locations.length,_)} `}),h.address]},_)}))})})]})]})})}export{Ve as R};
